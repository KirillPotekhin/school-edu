<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –¥–ª—è –¥–µ—Ç–µ–π</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --pad: 25px;
      --gap: 12px;
      --keypad-h: 210px;
      --actions-h: 64px;
      --actions-gap: 14px;
      --safe: env(safe-area-inset-bottom, 0px);

      --actions-bottom: 297px;
    }
    *{ box-sizing: border-box; }

    body{
      font-family: system-ui, -apple-system, "Nunito", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 0 var(--pad);
      margin: 0;
      color: #333;
      height: 100dvh;
      overflow: hidden;
      position: relative;
    }

    h1{
      text-align: center;
      font-size: 1.9em;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      margin: 10px 0 6px;
      height: 1.9em;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .menu{
      position: absolute;
      top: 6px;
      left: var(--pad);
      font-size: 2.4em;
      color: #fff;
      cursor: pointer;
      user-select: none;
      z-index: 50;
    }

    .modal-overlay{
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      justify-content: center;
      align-items: center;
    }

    .modal{
      background: #fff;
      width: 82%;
      max-width: 320px;
      height: 50vh;
      border-radius: 14px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    .modal-header{
      background: #667eea;
      color: #fff;
      padding: 12px;
      text-align: center;
      font-size: 1.2em;
      position: relative;
    }

    .modal-close{
      position: absolute;
      top: 10px;
      right: 12px;
      font-size: 1.2em;
      cursor: pointer;
    }

    .modal-content{
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .modal-content button{
      padding: 12px 14px;
      border: none;
      border-radius: 10px;
      background: #667eea;
      color: #fff;
      font-size: 1em;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .modal-content button.active{
      box-shadow: 0 0 8px rgba(0,0,0,0.4);
    }

    .header{
      text-align: center;
      font-size: 1.15em;
      color: #fff;
      margin-bottom: 6px;
    }

    .level-selector{
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 13px 0 24px 0;
      flex-wrap: nowrap;
      white-space: nowrap;
      background: transparent;
      padding: 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none; /* Firefox */
    }
    .level-selector::-webkit-scrollbar{ height: 0; }

    .level-selector button{
      margin: 0 6px;
      padding: 8px 14px;
      border: none;
      border-radius: 12px;
      background: rgba(255,255,255,0.16);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(0,0,0,0.18);
      backdrop-filter: blur(6px);
      font-size: 1em;
    }

    .level-selector button.active{
      background: rgba(255,255,255,0.28);
      box-shadow: 0 10px 20px rgba(0,0,0,0.22);
    }

    .progress-bar{
      width: 100%;
      height: 22px;
      background: rgba(255,255,255,0.3);
      border-radius: 12px;
      margin: 8px 0 14px;
      position: relative;
    }

    .progress-bar-fill{
      height: 100%;
      width: 0%;
      border-radius: 12px;
      background: linear-gradient(
        90deg,
        rgba(255, 99, 132, 0.85),
        rgba(255, 159, 64, 0.85),
        rgba(255, 205, 86, 0.85),
        rgba(75, 192, 192, 0.85),
        rgba(54, 162, 235, 0.85),
        rgba(153, 102, 255, 0.85)
      );
      background-size: 300% 100%;
      animation: rainbowFlow 6s ease-in-out infinite;
      transition: width 0.4s;
    }

    @keyframes rainbowFlow{
      0%{ background-position: 0% 50%; }
      50%{ background-position: 100% 50%; }
      100%{ background-position: 0% 50%; }
    }

    .progress-icon{
      position: absolute;
      top: 50%;
      right: 0;
      transform: translateY(-50%) translateX(26px);
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(180,225,255,0.95);
      box-shadow: 0 6px 6px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .progress-icon img{
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    #examples{
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;

      /* –º–µ—Å—Ç–æ –ø–æ–¥ –ø–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ + –∑–∞–∑–æ—Ä + –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É */
      height: calc(
        100dvh
        - 56px   /* –∑–∞–≥–æ–ª–æ–≤–æ–∫ h1 */
        - 30px   /* –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫/–æ—Ç—Å—Ç—É–ø—ã */
        - 70px   /* header + level selector */
        - 48px   /* progress bar */
        - var(--actions-h)
        - var(--actions-bottom)
        - var(--safe)
      );

      padding-bottom: calc(var(--actions-gap) + 10px);
      background: transparent;

      /* hide scrollbars */
      scrollbar-width: none; /* Firefox */
      -webkit-mask-image: linear-gradient(to bottom,
        rgba(0,0,0,0) 0px,
        rgba(0,0,0,1) 8px,
        rgba(0,0,0,1) calc(100% - 10px),
        rgba(0,0,0,0) 100%);
      mask-image: linear-gradient(to bottom,
        rgba(0,0,0,0) 0px,
        rgba(0,0,0,1) 8px,
        rgba(0,0,0,1) calc(100% - 14px),
        rgba(0,0,0,0) 100%);
    }
    #examples::-webkit-scrollbar{ width: 0; height: 0; }

    /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π "—Ñ–µ–π–¥" —Å–Ω–∏–∑—É —Å–ø–∏—Å–∫–∞ (–ø—Ä–∏—è—Ç–Ω—ã–π —Å–∫—Ä–æ–ª–ª) */
    #examples{
      -webkit-mask-image: linear-gradient(to bottom, transparent 0px, black 16px, black calc(100% - 24px), transparent 100%);
      mask-image: linear-gradient(to bottom, transparent 0px, black 16px, black calc(100% - 24px), transparent 100%);
    }


    .example{
      margin: var(--gap) 0;
      padding: 10px 8px;
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.18);
      font-size: 1.25em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
      min-height: 56px;
    }

    .example .expr{
      font-size: 1.02em;
      max-width: 84%;
      overflow-x: auto;
      white-space: nowrap;
    }

    .example input{
      width: 60px;
      height: 36px;
      font-size: 1.2em;
      border: 2px solid #667eea;
      border-radius: 14px;
      text-align: center;
      background: #fff;
    }

    .example.correct{ outline: 3px solid rgba(0,200,0,0.35); }
    .example.incorrect{ outline: 3px solid rgba(255,0,0,0.3); }

    .button-row{
      position: fixed;
      left: 0;
      right: 0;
      bottom: var(--actions-bottom);
      height: var(--actions-h);
      margin: 0 var(--pad);
      padding: 10px;
      display: flex;
      gap: 12px;
      justify-content: center;
      border-radius: 18px;
      z-index: 998;
      background: transparent;
    }


    .action-button{
      flex: 1;
      max-width: 260px;
      padding: 14px;
      border-radius: 18px;
      border: none;
      background: #667eea;
      color: #fff;
      font-size: 1.05em;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 10px 18px rgba(0,0,0,0.18);
    }

    .keypad{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 12px var(--pad) calc(12px + var(--safe));
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(12px);
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      box-shadow: 0 -10px 24px rgba(0,0,0,0.18);
      z-index: 999;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .keypad button{
      height: 56px;
      font-size: 22px;
      border-radius: 16px;
      border: none;
      background: #667eea;
      color: #fff;
      cursor: pointer;
    }

    .keypad button.secondary{ background: #764ba2; }

    .result-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .result-message{
      background: #fff;
      padding: 22px;
      border-radius: 16px;
      font-size: 1.5em;
      color: #667eea;
      text-align: center;
    }

    .firework{
      position: absolute;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      animation: explode 5s ease-in-out;
    }

    @keyframes explode{
      0%{ transform: scale(0); opacity: 1; }
      50%{ transform: scale(20); opacity: 0.5; }
      100%{ transform: scale(40); opacity: 0; }
    }
      

    }
    #examples::-webkit-scrollbar{
      width: 0;
      height: 0;
    }
    /* subtle fade at the top of the scroll area (nice on mobile) */
    #examples{
      -webkit-mask-image: linear-gradient(to bottom, transparent 0px, black 18px, black 100%);
      mask-image: linear-gradient(to bottom, transparent 0px, black 18px, black 100%);
    }

    /* hide "cut corner" under the action bar + add a soft fade */
    .button-row{
      overflow: hidden;
      position: fixed; /* ensure pseudo-element positioning */
    }
</style>
</head>

<body>
  <div class="menu" onclick="toggleMenu()">‚ò∞</div>

  <div class="modal-overlay" id="modalOverlay" onclick="closeMenu()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">–ú–µ–Ω—é
        <div class="modal-close" onclick="closeMenu()">√ó</div>
      </div>
      <div class="modal-content">
        <button id="multiplyBtn" onclick="setTab('multiply')">–¢–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è</button>
        <button id="additionBtn" onclick="setTab('addition')">–¢–∞–±–ª–∏—Ü–∞ —Å–ª–æ–∂–µ–Ω–∏—è</button>
        <button id="multiBtn" onclick="setTab('multi')">–ü–æ—Ä—è–¥–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π</button>
      </div>
    </div>
  </div>

  <h1>–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</h1>
  <div class="header" id="header"></div>
  <div class="level-selector" id="levelSelector"></div>

  <div class="progress-bar">
    <div class="progress-bar-fill" id="progressFill"></div>
    <div class="progress-icon" id="rocket">
      <img src="img/goose.png" alt="–ì—É—Å—å">
    </div>
  </div>

  <div id="examples"></div>

  <div class="button-row">
    <button onclick="checkAll()" class="action-button"><i class="fas fa-check"></i>–ü—Ä–æ–≤–µ—Ä–∫–∞</button>
    <button onclick="generateExamples()" class="action-button"><i class="fas fa-sync-alt"></i>–û–±–Ω–æ–≤–∏—Ç—å</button>
  </div>

  <div class="result-overlay" id="resultOverlay">
    <div class="result-message" id="resultMessage"></div>
    <div id="fireworks"></div>
  </div>

  <div class="keypad" id="keypad">
    <button onclick="kp('1')">1</button>
    <button onclick="kp('2')">2</button>
    <button onclick="kp('3')">3</button>
    <button onclick="kp('4')">4</button>
    <button onclick="kp('5')">5</button>
    <button onclick="kp('6')">6</button>
    <button onclick="kp('7')">7</button>
    <button onclick="kp('8')">8</button>
    <button onclick="kp('9')">9</button>
    <button class="secondary" onclick="kpBack()">‚å´</button>
    <button onclick="kp('0')">0</button>
    <button class="secondary" onclick="kpClear()">C</button>
  </div>

  
<script>


  let currentTab = 'times';        // times | sums | order
  let currentLevel = 1;            // –¥–ª—è "–ü–æ—Ä—è–¥–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π": 1-3
  let currentSub = 'mul';          // –¥–ª—è times: mul|div|mix ; –¥–ª—è sums: add|sub|mix          // –¥–ª—è times: mul|div|mix ; –¥–ª—è sums: add|sub|mix
  let examples = [];
  let activeInput = null;

  function randInt(min, max){
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  // —à–∫–æ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –ø–æ—Ä—è–¥–∫—É –¥–µ–π—Å—Ç–≤–∏–π + –∑–∞–ø—Ä–µ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö
  function evalSafeFlat(tokens){
    const arr = tokens.map(t => ({...t}));

    // 1) * /
    let i = 0;
    while (i < arr.length){
      if (arr[i].type === 'op' && (arr[i].value === '*' || arr[i].value === '/')){
        const op = arr[i].value;
        const left = arr[i-1].value;
        const right = arr[i+1].value;

        let res;
        if (op === '*'){
          if (left > 10 || right > 10) return { ok:false };
          res = left * right;
        } else {
          if (right === 0) return { ok:false };
          if (left % right !== 0) return { ok:false };
          res = left / right;
          if (!Number.isInteger(res)) return { ok:false };
          if (right > 10 || res > 10) return { ok:false };
        }

        arr.splice(i-1, 3, { type:'num', value: res });
        i = Math.max(0, i-2);
      } else {
        i++;
      }
    }

    // 2) + -
    let result = arr[0].value;
    for (let j = 1; j < arr.length; j += 2){
      const op = arr[j].value;
      const num = arr[j+1].value;
      if (op === '+') result += num;
      else result -= num;
      if (result < 0) return { ok:false };
    }

    return { ok:true, value: result };
  }

  // –∫–æ–Ω—Ç—Ä–æ–ª—å –ø–æ–≤—Ç–æ—Ä–æ–≤ —á–∏—Å–µ–ª: –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö –¥–æ–ø—É—Å–∫–∞–µ–º —á–∏—Å–ª–æ –¥–æ 2 —Ä–∞–∑
  function canUseNumber(n, freqMap){
    const limit = (currentTab === 'order') ? 1 : 2;
    return (freqMap.get(n) || 0) < limit;
  }
  function addNumber(n, freqMap){
    freqMap.set(n, (freqMap.get(n) || 0) + 1);
  }

  function toggleMenu() {
    document.getElementById('modalOverlay').style.display = 'flex';
  }
  function closeMenu() {
    document.getElementById('modalOverlay').style.display = 'none';
  }

  function setTab(tab) {
    currentTab = tab;

    
    if(tab==='times') currentSub = 'mul';
    if(tab==='sums') currentSub = 'add';
// –¥–µ—Ñ–æ–ª—Ç—ã –¥–ª—è –ø–æ–¥—Ä–µ–∂–∏–º–æ–≤
    if (tab === 'times') currentSub = 'mix';
    if (tab === 'sums') currentSub = 'mix';

    closeMenu();
    updateHeader();
    renderSelector();
    generateExamples();

    // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ id)
    document.getElementById('multiplyBtn').classList.remove('active');
    document.getElementById('additionBtn').classList.remove('active');
    document.getElementById('multiBtn').classList.remove('active');

    const btnId = tab === 'times' ? 'multiplyBtn' : tab === 'sums' ? 'additionBtn' : 'multiBtn';
    document.getElementById(btnId).classList.add('active');
  }

  function setSub(sub){
    currentSub = sub;
    renderSelector();
    generateExamples();
  }

  function setLevel(level) {
    currentLevel = level;
    renderSelector();
    generateExamples();
  }

  function updateHeader() {
    const header = document.getElementById('header');
    if (currentTab === 'order') header.textContent = '–ü–æ—Ä—è–¥–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π';
    else header.textContent = currentTab === 'times' ? '–¢–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è' : '–¢–∞–±–ª–∏—Ü–∞ —Å–ª–æ–∂–µ–Ω–∏—è';
  }

  // –µ–¥–∏–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä: –ª–∏–±–æ –ø–æ–¥—Ä–µ–∂–∏–º—ã, –ª–∏–±–æ —É—Ä–æ–≤–Ω–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
  function renderSelector() {
    const selector = document.getElementById('levelSelector');

    if (currentTab === 'times') {
      // 3-–π —Ä–µ–∂–∏–º: "–°–º–µ—à–∞–Ω–Ω—ã–µ" (—É–º–Ω–æ–∂–µ–Ω–∏–µ –∏ –¥–µ–ª–µ–Ω–∏–µ –≤–ø–µ—Ä–µ–º–µ—à–∫—É)
      selector.innerHTML = `
        <button onclick="setSub('mul')" data-sub="mul">–£–º–Ω–æ–∂–µ–Ω–∏–µ</button>
        <button onclick="setSub('div')" data-sub="div">–î–µ–ª–µ–Ω–∏–µ</button>
        <button onclick="setSub('mix')" data-sub="mix">–°–º–µ—à–∞–Ω–Ω—ã–µ</button>
      `;
      selector.querySelectorAll('button').forEach(b => b.classList.remove('active'));
      const b = selector.querySelector(`button[data-sub="${currentSub}"]`);
      if (b) b.classList.add('active');
      return;
    }

    if (currentTab === 'sums') {
      // 3-–π —Ä–µ–∂–∏–º: "–°–º–µ—à–∞–Ω–Ω—ã–µ" (—Å–ª–æ–∂–µ–Ω–∏–µ –∏ –≤—ã—á–∏—Ç–∞–Ω–∏–µ –≤–ø–µ—Ä–µ–º–µ—à–∫—É)
      selector.innerHTML = `
        <button onclick="setSub('add')" data-sub="add">–°–ª–æ–∂–µ–Ω–∏–µ</button>
        <button onclick="setSub('sub')" data-sub="sub">–í—ã—á–∏—Ç–∞–Ω–∏–µ</button>
        <button onclick="setSub('mix')" data-sub="mix">–°–º–µ—à–∞–Ω–Ω—ã–µ</button>
      `;
      selector.querySelectorAll('button').forEach(b => b.classList.remove('active'));
      const b = selector.querySelector(`button[data-sub="${currentSub}"]`);
      if (b) b.classList.add('active');
      return;
    }

    // order
    selector.innerHTML = `
      <button onclick="setLevel(1)" data-level="1">–õ–µ–≥–∫–∏–π</button>
      <button onclick="setLevel(2)" data-level="2">–°—Ä–µ–¥–Ω–∏–π</button>
      <button onclick="setLevel(3)" data-level="3">–°–ª–æ–∂–Ω—ã–π</button>
    `;
    selector.querySelectorAll('button').forEach(b => b.classList.remove('active'));
    const b = selector.querySelector(`button[data-level="${currentLevel}"]`);
    if (b) b.classList.add('active');
  }

  function generateExamples() {
    const container = document.getElementById('examples');
    container.innerHTML = '';
    examples = [];
    activeInput = null;

    const count = (currentTab === 'order') ? 4 : 10;

    const usedExpr = new Set();
    const pairUsed = new Set();     // —á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –ø–∞—Ä—ã (a,op,b)
    const numberFreqMap = new Map();

    function addExample(expression, correct){
      const exampleDiv = document.createElement('div');
      exampleDiv.className = 'example';
      exampleDiv.innerHTML = `
        <span class="expr">${expression} =</span>
        <input
          type="text"
          readonly
          inputmode="none"
          data-correct="${correct}"
          onclick="setActive(this)"
          onfocus="this.blur()"
          placeholder="?"
        >
      `;
      exampleDiv.onclick = () => setActive(exampleDiv.querySelector('input'));

      container.appendChild(exampleDiv);
      examples.push({ div: exampleDiv, correct: correct });
    }

    for (let i = 0; i < count; i++) {
      let expression = null, correct = null;

      // ===== –¢–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è =====
      if (currentTab === 'times') {
        let op = '*';
        if (currentSub === 'mul') op = '*';
        if (currentSub === 'div') op = '/';
        if (currentSub === 'mix') op = (i < 5 ? '*' : '/'); // 5* + 5/

        for (let t = 0; t < 500; t++){
          let a = randInt(2, 10);
          let b = randInt(2, 10);  // –¥–µ–ª–µ–Ω–∏–µ/—É–º–Ω–æ–∂–µ–Ω–∏–µ –Ω–∞ 10 –æ—Å—Ç–∞–≤–ª—è–µ–º
          if (a === b) continue;   // —É–±–∏—Ä–∞–µ–º a*a –∏ a/a
          if (!canUseNumber(a, numberFreqMap)) continue;
          if (!canUseNumber(b, numberFreqMap)) continue;

          if (op === '*'){
            expression = `${a} * ${b}`;
            correct = a * b;
          } else {
            const dividend = a * b;   // –¥–µ–ª–µ–Ω–∏–µ –±–µ–∑ –æ—Å—Ç–∞—Ç–∫–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
            expression = `${dividend} / ${b}`;
            correct = a;
          }

          const keyPair = `${op}:${a}:${b}`;
          if (pairUsed.has(keyPair)) continue;
          if (usedExpr.has(expression)) continue;

          pairUsed.add(keyPair);
          usedExpr.add(expression);
          addNumber(a, numberFreqMap);
          addNumber(b, numberFreqMap);
          break;
        }

        // fallback
        if (!expression){
          const b = randInt(2, 10);
          const a = randInt(2, 10);
          if (op === '*'){ expression = `${b} * ${a}`; correct = b*a; }
          else { expression = `${b*a} / ${b}`; correct = a; }
        }

        addExample(expression, correct);
        continue;
      }

      // ===== –¢–∞–±–ª–∏—Ü–∞ —Å–ª–æ–∂–µ–Ω–∏—è =====
      if (currentTab === 'sums') {
        let op = '+';
        if (currentSub === 'add') op = '+';
        if (currentSub === 'sub') op = '-';
        if (currentSub === 'mix') op = (Math.random() < 0.5 ? '+' : '-');

        for (let t = 0; t < 500; t++){
          let a = randInt(0, 20);
          let b = randInt(0, 20);
          if (!canUseNumber(a, numberFreqMap)) continue;
          if (!canUseNumber(b, numberFreqMap)) continue;

          if (op === '+'){
            if (a + b > 20) continue;
            expression = `${a} + ${b}`;
            correct = a + b;
          } else {
            if (a < b) continue;
            expression = `${a} - ${b}`;
            correct = a - b;
          }

          const keyPair = `${op}:${a}:${b}`;
          if (pairUsed.has(keyPair)) continue;
          if (usedExpr.has(expression)) continue;

          pairUsed.add(keyPair);
          usedExpr.add(expression);
          addNumber(a, numberFreqMap);
          addNumber(b, numberFreqMap);
          break;
        }

        // fallback
        if (!expression){
          const a = randInt(0, 20);
          const b = randInt(0, 20);
          if (op === '+'){
            const bb = Math.min(b, 20 - a);
            expression = `${a} + ${bb}`;
            correct = a + bb;
          } else {
            const aa = Math.max(a, b);
            const bb = Math.min(a, b);
            expression = `${aa} - ${bb}`;
            correct = aa - bb;
          }
        }

        addExample(expression, correct);
        continue;
      }

      // ===== –ü–æ—Ä—è–¥–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π =====
      if (currentTab === 'order') {
        const use2Brackets = currentLevel >= 3;

        function makeBracket(){
          const opIn = Math.random() < 0.5 ? '+' : '-';
          let x, y, val;

          for (let t = 0; t < 220; t++){
            x = randInt(1, 10);
            y = randInt(1, 10);

            if (!canUseNumber(x, numberFreqMap)) continue;
            if (!canUseNumber(y, numberFreqMap)) continue;

            if (opIn === '-'){
              if (x <= y) continue;
              val = x - y;
            } else {
              val = x + y;
            }
            if (val <= 0) continue;

            addNumber(x, numberFreqMap);
            addNumber(y, numberFreqMap);
            return { text: `(${x} ${opIn} ${y})`, value: val };
          }
          return { text: `(9 - 3)`, value: 6 };
        }

        function makeNumber(){
          for (let t = 0; t < 200; t++){
            const n = randInt(1, 10);
            if (!canUseNumber(n, numberFreqMap)) continue;
            addNumber(n, numberFreqMap);
            return n;
          }
          return randInt(1, 10);
        }

        function buildExpression(){
          const b1 = makeBracket();
          const b2 = use2Brackets ? makeBracket() : null;

          let terms = [];
          if (currentLevel === 1){
            const n1 = makeNumber();
            const n2 = makeNumber();
            terms = [ {text: `${n1}`, value: n1}, b1, {text: `${n2}`, value: n2} ];
          } else if (currentLevel === 2){
            const n1 = makeNumber();
            const n2 = makeNumber();
            terms = [ b1, {text: `${n1}`, value: n1}, {text: `${n2}`, value: n2} ];
          } else {
            const n1 = makeNumber();
            const n2 = makeNumber();
            terms = [ b1, b2, {text: `${n1}`, value: n1}, {text: `${n2}`, value: n2} ];
          }

          // –≤–Ω–µ —Å–∫–æ–±–æ–∫ ‚Äî –º–µ–Ω—è–µ–º –∑–Ω–∞–∫–∏, –∏ —á–∞—â–µ * /
          const ops = [];
          let last = null;
          for (let i = 0; i < terms.length - 1; i++){
            let op;
            for (let t = 0; t < 120; t++){
              op = (Math.random() < 0.7) ? (Math.random() < 0.5 ? '*' : '/') : (Math.random() < 0.5 ? '+' : '-');
              if (op === last) continue;
              last = op;
              break;
            }
            ops.push(op);
          }

          // –¥–µ–ª–µ–Ω–∏–µ ‚Äî –¥–µ–ª–∏—Ç—Å—è –Ω–∞—Ü–µ–ª–æ
          for (let i = 0; i < ops.length; i++){
            if (ops[i] === '/'){
              const left = terms[i].value;
              let right = terms[i+1].value;

              let found = false;
              for (let d = 2; d <= 10; d++){
                if (left % d === 0){
                  right = d;
                  found = true;
                  break;
                }
              }
              if (!found) right = 2;
              terms[i+1] = { text: `${right}`, value: right };
            }
          }

          const tokens = [];
          for (let i = 0; i < terms.length; i++){
            tokens.push({ type:'num', value: terms[i].value });
            if (i < ops.length) tokens.push({ type:'op', value: ops[i] });
          }
          const r = evalSafeFlat(tokens);
          if (!r.ok) return null;

          const parts = [];
          for (let i = 0; i < terms.length; i++){
            parts.push(terms[i].text);
            if (i < ops.length) parts.push(ops[i]);
          }
          return { expression: parts.join(' '), correct: r.value };
        }

        let built = null;
        for (let t = 0; t < 260; t++){
          built = buildExpression();
          if (built) break;
        }
        if (!built){
          expression = `(9 - 3) + 4 * 2`;
          correct = (9 - 3) + 4 * 2;
        } else {
          expression = built.expression;
          correct = built.correct;
        }

        addExample(expression, correct);
        continue;
      }
    }

    updateProgress();
    setTimeout(() => {
      const first = document.querySelector('.example input');
      if (first) setActive(first);
    }, 0);
  }

  function setActive(el){
    activeInput = el;
    document.querySelectorAll('.example input').forEach(i => i.style.outline = 'none');
    el.style.outline = '3px solid rgba(102,126,234,0.5)';

    // –º—è–≥–∫–∏–π –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–∏–º–µ—Ä –≤–Ω–µ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
    const card = el.closest('.example');
    if (!card) return;

    const r = card.getBoundingClientRect();
    const topSafe = 140; // —à–∞–ø–∫–∞ + –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏
    const bottomSafe = window.innerHeight - 340; // –∫–Ω–æ–ø–∫–∏ + –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞

    if (r.top < topSafe || r.bottom > bottomSafe){
      card.scrollIntoView({behavior:'smooth', block:'center'});
    }
  }

  // ===== KEYPAD LOGIC =====
  
  function kp(ch){
    timerStartIfNeeded();
    if(!activeInput){
      const firstEmpty = [...document.querySelectorAll('.example input')].find(i => i.value === '');
      if(firstEmpty) setActive(firstEmpty);
      else {
        const first = document.querySelector('.example input');
        if (first) setActive(first);
      }
    }
    if (!activeInput) return;

    const correctStr = activeInput.dataset.correct ? String(activeInput.dataset.correct) : "";
    const targetLen = Math.max(1, correctStr.length);

    if (activeInput.value.length >= targetLen) return;

    activeInput.value += ch;
    updateProgress();

    if (activeInput.value.length >= targetLen){
      const inputs = [...document.querySelectorAll('.example input')];
      const idx = inputs.indexOf(activeInput);

      let next = null;
      for (let j = idx + 1; j < inputs.length; j++){
        if (inputs[j].value === '') { next = inputs[j]; break; }
      }
      if (!next && idx + 1 < inputs.length) next = inputs[idx + 1];
      if (next) setActive(next);
    }
  }

function kpBack(){
    if(!activeInput) return;
    activeInput.value = activeInput.value.slice(0, -1);
    updateProgress();
  }

  function kpClear(){
    if(!activeInput) return;
    activeInput.value = '';
    updateProgress();
  }

  function checkAll() {
    let correctCount = 0;

    examples.forEach(item => {
      const input = item.div.querySelector('input');
      const correct = parseInt(input.dataset.correct);
      const user = parseInt(input.value);

      if (!Number.isNaN(user) && user === correct) {
        item.div.classList.add('correct');
        item.div.classList.remove('incorrect');
        correctCount++;
      } else {
        item.div.classList.add('incorrect');
        item.div.classList.remove('correct');
      }
    });

    const percent = (correctCount / examples.length) * 100;
    const overlay = document.getElementById('resultOverlay');
    const message = document.getElementById('resultMessage');

    const timeStr = timerStopFormatted();
    overlay.style.display = 'flex';

    if (percent === 100) message.textContent = 'üéâ –£—Ä–∞! 100%';
    if(timeStr){ message.textContent += '\n' + timeStr; }
    else if (percent >= 80) message.textContent = `üëè –û—Ç–ª–∏—á–Ω–æ! ${Math.round(percent)}%`;
    else if (percent >= 70) message.textContent = `üí™ –•–æ—Ä–æ—à–æ! ${Math.round(percent)}%`;
    else message.textContent = `–ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑: ${Math.round(percent)}%`;

    launchFireworks();
    setTimeout(() => { overlay.style.display = 'none'; }, 2500);
  }

  function launchFireworks() {
    const fireworks = document.getElementById('fireworks');
    fireworks.innerHTML = '';
    for (let i = 0; i < 20; i++) {
      const firework = document.createElement('div');
      firework.className = 'firework';
      firework.style.left = Math.random() * 100 + '%';
      firework.style.top = Math.random() * 100 + '%';
      firework.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
      fireworks.appendChild(firework);
    }
  }

  function updateProgress() {
    const filled = examples.filter(item => item.div.querySelector('input').value !== '').length;
    const total = examples.length;
    const percent = total ? (filled / total) * 100 : 0;

    document.getElementById('progressFill').style.width = percent + '%';
    document.getElementById('rocket').style.right = (100 - percent) + '%';
    document.getElementById('rocket').style.transform = 'translateY(-50%) translateX(26px)';
    document.getElementById('rocket').style.left = 'auto';
  }

  // init
  updateHeader();
  renderSelector();
  generateExamples();
  // map old tabs (–µ—Å–ª–∏ –≤ HTML –æ—Å—Ç–∞–ª–∏—Å—å —Å—Ç–∞—Ä—ã–µ onclick)
  const _setTab = setTab;
  window.setTab = function(tab){
    if (tab === 'multiply') return _setTab('times');
    if (tab === 'addition') return _setTab('sums');
    if (tab === 'multi') return _setTab('order');
    return _setTab(tab);
  };



  // ===== TIMER (patched) =====
  let timerStart = null;
  let timerRunning = false;

  function timerStartIfNeeded(){
    if(!timerRunning){
      timerRunning = true;
      timerStart = Date.now();
    }
  }

  function timerStopFormatted(){
    if(!timerRunning || !timerStart) return '';
    const sec = Math.floor((Date.now() - timerStart)/1000);
    timerRunning = false;
    timerStart = null;
    if(sec < 60) return `–í—Ä–µ–º—è: ${sec} —Å–µ–∫`;
    const m = Math.floor(sec/60);
    const s = sec % 60;
    return `–í—Ä–µ–º—è: ${m} –º–∏–Ω ${s} —Å–µ–∫`;
  }

</script>

</body>
</html>
